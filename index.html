<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Pro - Merge & Extract</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .tab-active {
            border-color: #4f46e5;
            color: #4f46e5;
            font-weight: 600;
        }
        .page-thumbnail {
            position: relative;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            overflow: hidden;
            cursor: grab;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .page-thumbnail:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .page-number {
            position: absolute;
            bottom: 4px;
            right: 4px;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 2px 6px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .file-name {
            position: absolute;
            top: 4px;
            left: 4px;
            background-color: rgba(79, 70, 229, 0.8);
            color: white;
            padding: 2px 8px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            max-width: calc(100% - 16px);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .sortable-ghost {
            opacity: 0.4;
            border: 2px dashed #4f46e5;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <!-- Loading Modal -->
    <div id="loading-modal" class="modal-overlay hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl text-center flex flex-col items-center">
            <div class="loader mb-4"></div>
            <p id="loading-text" class="text-lg font-medium text-slate-700">Processing...</p>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <!-- Header -->
        <header class="text-center mb-12">
            <h1 class="text-4xl font-bold tracking-tight text-indigo-600 sm:text-5xl">PDF Pro</h1>
            <p class="mt-3 text-lg text-slate-600 max-w-2xl mx-auto">Your simple, private, and powerful browser-based PDF toolkit.</p>
        </header>

        <!-- Tabs -->
        <div class="mb-8 border-b border-gray-200">
            <nav class="-mb-px flex justify-center space-x-8" aria-label="Tabs">
                <button id="tab-merge" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg tab-active">Merge PDFs</button>
                <button id="tab-extract" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg text-gray-500 hover:text-gray-700 hover:border-gray-300">Extract Pages</button>
            </nav>
        </div>

        <!-- Main Content -->
        <main>
            <!-- Merge Tool -->
            <div id="tool-merge">
                <div class="bg-white p-8 rounded-xl shadow-md border border-slate-200">
                    <h2 class="text-2xl font-bold mb-2 text-slate-800">Merge PDFs</h2>
                    <p class="text-slate-500 mb-6">Upload multiple PDFs, then drag and drop pages to set the final order.</p>

                    <div class="mb-6">
                        <label for="merge-files-input" class="w-full h-32 flex flex-col items-center justify-center rounded-lg border-2 border-dashed border-slate-300 bg-slate-50 hover:bg-slate-100 cursor-pointer transition">
                            <svg class="w-10 h-10 text-slate-400 mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0l-3.75 3.75M12 9.75l3.75 3.75M3 17.25V6.75A2.25 2.25 0 015.25 4.5h13.5A2.25 2.25 0 0121 6.75v10.5A2.25 2.25 0 0118.75 19.5H5.25A2.25 2.25 0 013 17.25z" />
                            </svg>
                            <span class="font-medium text-indigo-600">Click to upload files</span>
                            <span class="text-sm text-slate-500">or drag and drop</span>
                        </label>
                        <input id="merge-files-input" type="file" class="hidden" multiple accept=".pdf">
                    </div>

                    <div id="page-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-8 gap-4 min-h-[150px]">
                        <!-- Page thumbnails will be injected here -->
                    </div>
                    
                    <div id="merge-actions" class="mt-8 pt-6 border-t border-slate-200 flex items-center justify-between hidden">
                         <button id="clear-merge-btn" class="text-sm font-medium text-slate-500 hover:text-red-600 transition">Clear All</button>
                        <button id="merge-btn" class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition disabled:opacity-50 disabled:cursor-not-allowed">
                            Merge PDFs & Download
                        </button>
                    </div>
                </div>
            </div>

            <!-- Extract Tool -->
            <div id="tool-extract" class="hidden">
                 <div class="bg-white p-8 rounded-xl shadow-md border border-slate-200">
                    <h2 class="text-2xl font-bold mb-2 text-slate-800">Extract Pages</h2>
                    <p class="text-slate-500 mb-6">Upload a PDF, choose the page range to keep, and create a new file.</p>
                    
                    <div id="extract-upload-area">
                        <label for="extract-file-input" class="w-full h-32 flex flex-col items-center justify-center rounded-lg border-2 border-dashed border-slate-300 bg-slate-50 hover:bg-slate-100 cursor-pointer transition">
                            <svg class="w-10 h-10 text-slate-400 mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m.158 10.308l-3.08 3.08a1.5 1.5 0 000 2.121l6.162 6.162a1.5 1.5 0 002.121 0l3.08-3.08m-3.75-3.75l.375.375m-.375-.375l-3.75 3.75M3 17.25V6.75A2.25 2.25 0 015.25 4.5h13.5A2.25 2.25 0 0121 6.75v10.5A2.25 2.25 0 0118.75 19.5H5.25A2.25 2.25 0 013 17.25z" />
                            </svg>
                             <span class="font-medium text-indigo-600">Click to upload a file</span>
                            <span class="text-sm text-slate-500">or drag and drop</span>
                        </label>
                        <input id="extract-file-input" type="file" class="hidden" accept=".pdf">
                    </div>

                    <div id="extract-controls" class="hidden mt-6">
                        <div id="extract-file-info" class="mb-6 p-4 bg-slate-100 rounded-lg text-center">
                            <!-- File info will be injected here -->
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-end">
                            <div>
                                <label for="start-page" class="block text-sm font-medium text-slate-700">Start Page</label>
                                <input type="number" id="start-page" min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="end-page" class="block text-sm font-medium text-slate-700">End Page</label>
                                <input type="number" id="end-page" min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                            </div>
                        </div>

                        <div class="mt-8 pt-6 border-t border-slate-200 flex items-center justify-between">
                             <button id="clear-extract-btn" class="text-sm font-medium text-slate-500 hover:text-red-600 transition">Clear & Start Over</button>
                            <button id="extract-btn" class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition disabled:opacity-50 disabled:cursor-not-allowed">
                                Extract & Download
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Set up PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;

        // --- DOM Elements ---
        const tabMerge = document.getElementById('tab-merge');
        const tabExtract = document.getElementById('tab-extract');
        const toolMerge = document.getElementById('tool-merge');
        const toolExtract = document.getElementById('tool-extract');
        const loadingModal = document.getElementById('loading-modal');
        const loadingText = document.getElementById('loading-text');

        // --- Merge Tool Elements ---
        const mergeFilesInput = document.getElementById('merge-files-input');
        const pageContainer = document.getElementById('page-container');
        const mergeBtn = document.getElementById('merge-btn');
        const mergeActions = document.getElementById('merge-actions');
        const clearMergeBtn = document.getElementById('clear-merge-btn');

        // --- Extract Tool Elements ---
        const extractFileInput = document.getElementById('extract-file-input');
        const extractUploadArea = document.getElementById('extract-upload-area');
        const extractControls = document.getElementById('extract-controls');
        const extractFileInfo = document.getElementById('extract-file-info');
        const startPageInput = document.getElementById('start-page');
        const endPageInput = document.getElementById('end-page');
        const extractBtn = document.getElementById('extract-btn');
        const clearExtractBtn = document.getElementById('clear-extract-btn');

        // --- State ---
        let mergeFiles = []; // To store file objects and their array buffers for merging
        let extractFile = null; // To store the file for extraction

        // --- Utility Functions ---
        const showLoader = (text = 'Processing...') => {
            loadingText.textContent = text;
            loadingModal.classList.remove('hidden');
        };
        const hideLoader = () => {
            loadingModal.classList.add('hidden');
        };

        const downloadFile = (blob, filename) => {
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
        };

        // --- Tab Navigation ---
        const switchTab = (activeTab) => {
            if (activeTab === 'merge') {
                tabMerge.classList.add('tab-active');
                tabExtract.classList.remove('tab-active');
                toolMerge.classList.remove('hidden');
                toolExtract.classList.add('hidden');
            } else {
                tabMerge.classList.remove('tab-active');
                tabExtract.classList.add('tab-active');
                toolMerge.classList.add('hidden');
                toolExtract.classList.remove('hidden');
            }
        };

        tabMerge.addEventListener('click', () => switchTab('merge'));
        tabExtract.addEventListener('click', () => switchTab('extract'));

        // --- Merge Logic ---

        // Initialize SortableJS for drag-and-drop
        new Sortable(pageContainer, {
            animation: 150,
            ghostClass: 'sortable-ghost',
        });

        const renderPageThumbnail = async (file, fileIndex, pageNum) => {
            const pdf = await pdfjsLib.getDocument(file.arrayBuffer).promise;
            const page = await pdf.getPage(pageNum);
            const viewport = page.getViewport({ scale: 0.3 }); // Smaller scale for thumbnails
            
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;

            await page.render({ canvasContext: context, viewport: viewport }).promise;

            const wrapper = document.createElement('div');
            wrapper.className = 'page-thumbnail';
            // Store data needed for merging directly on the element
            wrapper.dataset.fileIndex = fileIndex;
            wrapper.dataset.pageIndex = pageNum - 1;

            const pageNumSpan = document.createElement('span');
            pageNumSpan.className = 'page-number';
            pageNumSpan.textContent = pageNum;
            
            const fileNameSpan = document.createElement('span');
            fileNameSpan.className = 'file-name';
            fileNameSpan.textContent = file.file.name;
            fileNameSpan.title = file.file.name;

            wrapper.appendChild(canvas);
            wrapper.appendChild(pageNumSpan);
            wrapper.appendChild(fileNameSpan);
            pageContainer.appendChild(wrapper);
        };

        const handleMergeFiles = async (files) => {
            if (files.length === 0) return;
            showLoader('Loading files...');
            
            for (const file of files) {
                const arrayBuffer = await file.arrayBuffer();
                const fileData = { file, arrayBuffer };
                const fileIndex = mergeFiles.length;
                mergeFiles.push(fileData);

                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                for (let i = 1; i <= pdf.numPages; i++) {
                    await renderPageThumbnail(fileData, fileIndex, i);
                }
            }
            
            mergeActions.classList.remove('hidden');
            hideLoader();
        };

        mergeFilesInput.addEventListener('change', (e) => handleMergeFiles(e.target.files));
        
        // Drag and drop handler for merge
        toolMerge.addEventListener('dragover', (e) => { e.preventDefault(); e.stopPropagation(); });
        toolMerge.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            if (e.dataTransfer.files) {
                handleMergeFiles(e.dataTransfer.files);
            }
        });

        clearMergeBtn.addEventListener('click', () => {
            mergeFiles = [];
            pageContainer.innerHTML = '';
            mergeActions.classList.add('hidden');
            mergeFilesInput.value = ''; // Reset file input
        });

        mergeBtn.addEventListener('click', async () => {
            if (pageContainer.children.length === 0) return;
            showLoader('Merging PDFs...');
            
            try {
                const { PDFDocument } = PDFLib;
                const mergedPdf = await PDFDocument.create();
                const pageElements = Array.from(pageContainer.children);

                for (const pageElement of pageElements) {
                    const { fileIndex, pageIndex } = pageElement.dataset;
                    const sourceFile = mergeFiles[parseInt(fileIndex)];
                    
                    const sourcePdf = await PDFDocument.load(sourceFile.arrayBuffer);
                    const [copiedPage] = await mergedPdf.copyPages(sourcePdf, [parseInt(pageIndex)]);
                    mergedPdf.addPage(copiedPage);
                }

                const mergedPdfBytes = await mergedPdf.save();
                downloadFile(new Blob([mergedPdfBytes], { type: 'application/pdf' }), 'merged.pdf');
            } catch (error) {
                console.error("Error merging PDFs:", error);
                alert("An error occurred while merging the PDFs. Please check the console for details.");
            } finally {
                hideLoader();
            }
        });

        // --- Extract Logic ---
        const handleExtractFile = async (file) => {
            if (!file) return;
            showLoader('Loading file...');
            
            try {
                const arrayBuffer = await file.arrayBuffer();
                extractFile = { file, arrayBuffer };

                const { PDFDocument } = PDFLib;
                const pdfDoc = await PDFDocument.load(arrayBuffer);
                const pageCount = pdfDoc.getPageCount();

                extractFileInfo.innerHTML = `
                    <p class="font-semibold text-slate-800">${file.name}</p>
                    <p class="text-sm text-slate-500">Total pages: ${pageCount}</p>
                `;
                startPageInput.value = 1;
                startPageInput.max = pageCount;
                endPageInput.value = pageCount;
                endPageInput.max = pageCount;

                extractUploadArea.classList.add('hidden');
                extractControls.classList.remove('hidden');
            } catch (error) {
                console.error("Error loading PDF for extraction:", error);
                alert("Could not read the selected PDF file. It might be corrupted or protected.");
                clearExtractState();
            } finally {
                hideLoader();
            }
        };
        
        const clearExtractState = () => {
            extractFile = null;
            extractFileInput.value = '';
            extractUploadArea.classList.remove('hidden');
            extractControls.classList.add('hidden');
        };
        
        extractFileInput.addEventListener('change', (e) => handleExtractFile(e.target.files[0]));
        
        // Drag and drop handler for extract
        toolExtract.addEventListener('dragover', (e) => { e.preventDefault(); e.stopPropagation(); });
        toolExtract.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
                handleExtractFile(e.dataTransfer.files[0]);
            }
        });

        clearExtractBtn.addEventListener('click', clearExtractState);

        extractBtn.addEventListener('click', async () => {
            if (!extractFile) return;

            const start = parseInt(startPageInput.value);
            const end = parseInt(endPageInput.value);
            const max = parseInt(endPageInput.max);

            if (isNaN(start) || isNaN(end) || start < 1 || end > max || start > end) {
                alert('Invalid page range. Please ensure Start Page is less than or equal to End Page, and both are within the document bounds.');
                return;
            }

            showLoader('Extracting pages...');
            
            try {
                const { PDFDocument } = PDFLib;
                const sourcePdf = await PDFDocument.load(extractFile.arrayBuffer);
                const newPdf = await PDFDocument.create();

                // Page indices are 0-based in pdf-lib
                const pagesToCopy = Array.from({ length: end - start + 1 }, (_, i) => start + i - 1);
                
                const copiedPages = await newPdf.copyPages(sourcePdf, pagesToCopy);
                copiedPages.forEach(page => newPdf.addPage(page));

                const newPdfBytes = await newPdf.save();
                downloadFile(new Blob([newPdfBytes], { type: 'application/pdf' }), `extracted_${extractFile.file.name}`);
            } catch (error) {
                console.error("Error extracting pages:", error);
                alert("An error occurred during extraction. Please check the console.");
            } finally {
                hideLoader();
            }
        });

    </script>
</body>
</html>
